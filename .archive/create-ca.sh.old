# On Certificate Authority (as a master)
openssl genrsa -aes256 -out ca-key.pem 4096
openssl req -x509 -new -key ca-key.pem -days 365 -subj '/CN=CertificateAuthority' -out ca-cert.pem
scp ca-cert.pem jsoehner@node1:/usr/local/share/ca-certificates
#
# On Each Node in your Cluster
openssl req -new -key server-key.pem -subj '/CN=node1' -out server.csr
openssl x509 -req -days 365 -in server.csr -CA ca-cert.pem -CAkey ca-key.pem -CAcreateserial -extfile <(echo "extendedKeyUsage = serverAuth") -out server-cert.pem
scp ca-cert.pem jsoehner@node1:/usr/local/share/ca-certificates
scp server-cert.pem jsoehner@node1:/etc/docker/certs
sudo update-ca-certificates
#
# Create Shell on node
# Update docker socket for certificates
docker_socket_d="/etc/systemd/system/docker.socket.d"
socket_override="${docker_socket_d}/override.conf"
sudo mkdir -p "${docker_socket_d}"
sudo tee "${socket_override}" <<EOF
[Socket]
# note: add in empty ListenStream directive to clear all previously defined sockets, otherwise this file is additive to the other sockets
ListenStream=
ListenStream=0.0.0.0:2375
EOF
sudo systemctl daemon-reload
sudo systemctl restart docker.socket
sudo update-ca-certificates

# On Each client to connect to cluster
openssl genrsa -out client-key.pem 2048
openssl req -new -key client-key.pem -subj '/CN=docker-client' -out client.csr
openssl x509 -req -days 365 -in client.csr -CA ca-cert.pem -CAkey ca-key.pem -CAcreateserial -extfile <(echo "extendedKeyUsage = clientAuth") -out client-cert.pem

# New TLS install
#
mkdir -p ssl
openssl genrsa -out ~/cluster-1/ssl/ca-key.pem 4096
openssl req -x509 -new -nodes -key ~/cluster-1/ssl/ca-key.pem -days 3650 -out ~/cluster-1/ssl/ca.pem -subj '/CN=docker-CA'

mkdir -p /etc/docker/ssl
sudo tee /etc/docker/ssl/openssl.cnf <<EOF
    [req]
    req_extensions = v3_req
    distinguished_name = req_distinguished_name
    [req_distinguished_name]
    [ v3_req ]
    basicConstraints = CA:FALSE
    keyUsage = nonRepudiation, digitalSignature, keyEncipherment
    extendedKeyUsage = serverAuth, clientAuth
    subjectAltName = @alt_names

    [alt_names]
    DNS.1 = cluster1
    DNS.2 = cluster1.jsigroup.local
    IP.1 = 127.0.0.1
    IP.2 = 192.168.100.110
EOF
#
# Prepare docker daemon certs for each host
#
sudo openssl genrsa -out /etc/docker/ssl/daemon-key.pem 4096
sudo openssl req -new -key /etc/docker/ssl/daemon-key.pem -out /etc/docker/ssl/daemon-cert.csr -subj '/CN=docker-daemon' -config /etc/docker/ssl/openssl.cnf
sudo openssl x509 -req -in /etc/docker/ssl/daemon-cert.csr -CA /etc/docker/ssl/ca.pem -CAkey ~/cluster-1/ssl/ca-key.pem -CAcreateserial -out /etc/docker/ssl/daemon-cert.pem -days 3650 -extensions v3_req -extfile /etc/docker/ssl/openssl.cnf
sudo chmod 600 /etc/docker/ssl/*

sudo tee /etc/docker/daemon.json <<EOF
{
    "icc": false,
    "tls": true,
    "tlsverify": true,
    "tlscacert": "/etc/docker/ssl/ca.pem",
    "tlscert": "/etc/docker/ssl/daemon-cert.pem",
    "tlskey": "/etc/docker/ssl/daemon-key.pem",
    "userland-proxy": false,
    "default-ulimit": "nofile=50:100",
    "hosts": ["unix:///var/run/docker.sock", "tcp://192.168.100.110:2376"]
  }
EOF

# Patch systemd for flag error
sudo cp /lib/systemd/system/docker.service /etc/systemd/system/
sudo sed -i 's/\ -H\ fd:\/\///g' /etc/systemd/system/docker.service
sudo systemctl daemon-reload
sudo service docker restart

scp /Users/jsoehner/cluster-1/ssl/ca.pem jsoehner@cluster1:~/.docker/ca.pem
scp /Users/jsoehner/cluster-1/ssl/client-key.pem jsoehner@cluster1:~/.docker/key.pem
scp /Users/jsoehner/cluster-1/ssl/client-cert.pem jsoehner@cluster1:~/.docker/cert.pem

# Additional settings
# Add additional AppArmor settings
#sudo tee /etc/apparmor.d/docker-server<<EOF
#    #include <tunables/global> 
#    
#    profile docker-labkey-myserver flags=(attach_disconnected,mediate_deleted) {
#
#        #include <abstractions/base>
#
#        network inet tcp,
#        network inet udp,
#        deny network inet icmp,
#        deny network raw,
#        deny network packet,
#        capability,
#        file,
#        umount,
#
#        deny @{PROC}/* w,   # deny write for all files directly in /proc (not in a subdir)
#        # deny write to files not in /proc/<number>/** or /proc/sys/**
#        deny @{PROC}/{[^1-9],[^1-9][^0-9],[^1-9s][^0-9y][^0-9s],[^1-9][^0-9][^0-9][^0-9]*}/** w,
#        deny @{PROC}/sys/[^k]** w,  # deny /proc/sys except /proc/sys/k* (effectively /proc/sys/kernel)
#        deny @{PROC}/sys/kernel/{?,??,[^s][^h][^m]**} w,  # deny everything except shm* in /proc/sys/kernel/
#        deny @{PROC}/sysrq-trigger rwklx,
#        deny @{PROC}/mem rwklx,
#        deny @{PROC}/kmem rwklx,
#        deny @{PROC}/kcore rwklx,
#
#        deny mount,
#
#        deny /sys/[^f]*/** wklx,
#        deny /sys/f[^s]*/** wklx,
#        deny /sys/fs/[^c]*/** wklx,
#        deny /sys/fs/c[^g]*/** wklx,
#        deny /sys/fs/cg[^r]*/** wklx,
#        deny /sys/firmware/efi/efivars/** rwklx,
#        deny /sys/kernel/security/** rwklx,
#
#        # suppress ptrace denials when using 'docker ps' or using 'ps' inside a container
#        ptrace (trace,read) peer=docker-labkey-myserver,
#
#        # Rules added by LabKey to deny running executables and accessing files
#        deny /bin/dash mrwklx,
#        deny /bin/bash mrwklx,
#        deny /bin/sh mrwklx,
#        deny /usr/bin/top mrwklx,
#        deny /usr/bin/apt* mrwklx,
#        deny /usr/bin/dpkg mrwklx,
#    
#        deny /bin/** wl,
#        deny /boot/** wl,
#        deny /dev/[^null]** wl,
#        deny /lib/** wl,
#        deny /lib64/** wl,
#        deny /media/** wl,
#        deny /mnt/** wl,
#        deny /opt/** wl,
#        deny /proc/** wl,
#        deny /root/** wl,
#        deny /sbin/** wl,
#        deny /srv/** wl,
#        deny /sys/** wl,
#        deny /usr/[^local]** wl,
#        deny /teamcity/** rwklx,
#        deny /labkey/** rwklx,
#        deny /share/files/** rwklx,    
#    }
#EOF

apparmor_parser -r -W /etc/apparmor.d/docker-server

